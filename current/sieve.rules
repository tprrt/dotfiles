require ["body","copy","fileinto","imap4flags","mailbox","regex","variables"];

# ====
# SPAM
# ====

# Legacy spam detection
if anyof (address :contains "to" "info@free-electrons.com") {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

if header :contains ["X-GND-Status"] ["MCE","PCE"] {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

if allof (header :contains ["X-GND-Status"] ["SPAM"], header :regex ["X-GND-Spam-Score"] ["[2-4][0-9][0-9]"]) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Standard spam headers (but exclude legitimate mailing lists)
if allof (
    anyof (
        header :contains "X-Spam-Flag" "YES",
        header :contains "X-Spam-Status" "Yes",
        header :regex "X-Spam-Score" "^([5-9]|[1-9][0-9]+)(\\.[0-9]+)?",  # Catches scores â‰¥5.0
        header :regex "X-Spam-Level" "\\*\\*\\*\\*\\*"
    ),
    not anyof (
        header :contains "List-Id" "vger.kernel.org",
        header :contains "List-Id" "lists.yoctoproject.org",
        header :contains "List-Id" "lists.openembedded.org",
        header :contains "List-Id" "lists.zephyrproject.org",
        header :contains "List-Id" "lists.freedesktop.org",
        header :contains "List-Id" "lists.bootlin.com",
        header :contains "List-Id" "lists.trustedfirmware.org",
        header :contains "List-Id" "lists.infradead.org",
        header :contains "List-Id" "buildroot.org",
        header :contains "List-Id" "busybox.net",
        header :contains "List-Id" "nongnu.org"
    )
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Common phishing and suspicious patterns
if anyof (
    header :regex :comparator "i;ascii-casemap" "Subject" "(urgent|action.*required|verify.*account|suspended|locked|expire|confirm|update.*payment)",
    header :regex :comparator "i;ascii-casemap" "Subject" "(winner|lottery|congratulations|inheritance|million|deposit)",
    header :regex :comparator "i;ascii-casemap" "Subject" "(viagra|cialis|pharmacy|pills|medication|enhancement)",
    header :regex :comparator "i;ascii-casemap" "Subject" "(earn.*money|work.*from.*home|make.*\\$|investment|profit)"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Cryptocurrency and gift card scams
if anyof (
    header :regex :comparator "i;ascii-casemap" "Subject" "(bitcoin|btc|ethereum|eth|crypto|blockchain|nft|wallet)",
    header :regex :comparator "i;ascii-casemap" "Subject" "(gift.*card|amazon.*card|itunes|google.*play|steam.*card)",
    body :regex :comparator "i;ascii-casemap" "(send.*bitcoin|crypto.*wallet|blockchain.*investment|nft.*opportunity)"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Fake reply abuse (Re: without proper In-Reply-To or References headers)
if allof (
    header :regex :comparator "i;ascii-casemap" "Subject" "^(re:|fwd?):",
    not exists "In-Reply-To",
    not exists "References"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Suspicious sender patterns
if anyof (
    address :regex :comparator "i;ascii-casemap" "from" "no-?reply@.*(tk|ml|ga|cf)",
    address :regex "from" "[0-9]+@",
    header :regex :comparator "i;ascii-casemap" "From" "(noreply|no-reply)@.*(tk|ml|ga|cf|info|biz)",
    header :contains "From" "undisclosed-recipients"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Missing or suspicious headers
if anyof (
    not exists "Message-ID",
    not exists "Date",
    header :regex "Received" "^\s*$"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Bulk/mass mailing indicators (excluding legitimate mailing lists)
if anyof (
    header :contains "X-Mailer" "Mass",
    header :contains "X-Mailer" "Bulk",
    header :contains "X-Priority" "5"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Bulk emails without proper mailing list headers
if allof (
    header :regex :comparator "i;ascii-casemap" "Precedence" "^(bulk|junk)$",
    not exists "List-Id",
    not exists "List-Unsubscribe"
) {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# Suspicious attachment patterns
if header :regex :comparator "i;ascii-casemap" "Content-Type" "application/(exe|bat|com|scr|vbs|jar|zip)" {
    fileinto "Junk";
    addflag "Junk";
    stop;
}

# HTML-only emails with suspicious content
if allof (
    header :contains "Content-Type" "text/html",
    not header :contains "Content-Type" "text/plain"
) {
    if body :regex :comparator "i;ascii-casemap" "<a[^>]*href[^>]*>(click|download|verify|update|confirm)" {
        fileinto "Junk";
        addflag "Junk";
        stop;
    }
}

# Charset obfuscation attempts (but exclude legitimate mailing lists and business emails)
if allof (
    header :regex "Content-Type" "charset=(koi8|windows-125[0-9]|iso-8859-[0-9]+)",
    not exists "List-Id",
    not exists "List-Unsubscribe",
    not address :contains ["from", "to", "cc"] "bootlin.com"
) {
    if body :regex :comparator "i;ascii-casemap" "(urgent|winner|viagra|cialis|loan|investment)" {
        fileinto "Junk";
        addflag "Junk";
        stop;
    }
}

# Reputation-based filtering
if anyof (
    allof (
        header :regex "Received" "\\[([0-9]{1,3}\\.){3}[0-9]{1,3}\\]",
        not header :contains "Received" "kernel.org",
        not header :contains "Received" "denx.de",
        not header :contains "Received" "google.com",
        not header :contains "Received" "galae.net",
        not header :contains "Received" "bootlin.com",
        not exists "List-Id",
        not exists "List-Unsubscribe"
    ),
    header :contains "Received" "unknown",
    header :regex "Received" "\\.(tk|ml|ga|cf)\\s"
) {
    if header :regex :comparator "i;ascii-casemap" "Subject" "(re:|fwd:)" {
        # Allow replies and forwards even from suspicious IPs - do nothing
    } else {
        fileinto "Junk";
        addflag "Junk";
        stop;
    }
}

# =========
# Filtering
# =========

if address :contains "from" "thomas.perrot@bootlin.com" {
    addflag "$label1";
}

if allof (address :contains ["to", "cc"] ["buildroot@buildroot.org", "buildroot@busybox.net"]) {
    fileinto "INBOX/Buildroot";
    stop;
}

if allof (address :contains ["to", "cc"] "bitbake-devel@lists.openembedded.org") {
    fileinto "INBOX/OpenEmbedded/bitbake-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "openembedded-core@lists.openembedded.org") {
    fileinto "INBOX/OpenEmbedded/openembedded-core";
    stop;
}

if allof (address :contains ["to", "cc"] "openembedded-devel@lists.openembedded.org") {
    fileinto "INBOX/OpenEmbedded/openembedded-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "openembedded-architecture@lists.openembedded.org") {
    fileinto "INBOX/OpenEmbedded/openembedded-architecture";
    stop;
}

if allof (address :contains ["to", "cc"] "yocto@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto";
    stop;
}

if allof (address :contains ["to", "cc"] "yocto-announce@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/yocto-announce";
    stop;
}

if allof (address :contains ["to", "cc"] "automated-testing@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/automated-testing";
    stop;
}

if anyof (address :contains ["to", "cc"] "bugzilla-daemon@yoctoproject.org", address :contains "from" "bugzilla-daemon@yoctoproject.org") {
    fileinto "INBOX/Yocto/bugzilla";
    stop;
}

if allof (address :contains "from" "controller@yoctoproject.org") {
    fileinto "INBOX/Yocto/controller";
    stop;
}

if allof (address :contains ["to", "cc"] "main@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/main";
    stop;
}

if allof (address :contains ["to", "cc"] "meta-arm@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/meta-arm";
    stop;
}

if allof (address :contains ["to", "cc"] "meta-freescale@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/meta-freescale";
    stop;
}

if allof (address :contains ["to", "cc"] "meta-ti@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/meta-ti";
    stop;
}

if allof (address :contains ["to", "cc"] "meta-virtualization@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/meta-virtualization";
    stop;
}

if allof (address :contains ["to", "cc"] "yocto-patches@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/yocto-patches";
    stop;
}

if allof (address :contains ["to", "cc"] "poky@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/poky";
    stop;
}

if allof (address :contains ["to", "cc"] "swat@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/swat";
    stop;
}

if allof (address :contains ["to", "cc"] "yocto-status@lists.yoctoproject.org") {
    fileinto "INBOX/Yocto/yocto-status";
    stop;
}

if allof (address :contains ["to", "cc"] "u-boot@lists.denx.de") {
    fileinto "INBOX/U-Boot";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-arm-msm@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-arm-msm";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-rt-users@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-rt-users";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-newbie@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-newbie";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-kernel-announce@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-kernel-announce";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-embedded@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-embedded";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-c-programming@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-c-programming";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-kernel@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-kernel";
    stop;
}

if allof (address :contains ["to", "cc"] "kernel-janitors@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-kernel-janitors";
    stop;
}

if allof (address :contains ["to", "cc"] "devicetree@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-devicetree";
    stop;
}

if allof (address :contains ["to", "cc"] "netdev@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-netdev";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-riscv@lists.infradead.org") {
    fileinto "INBOX/Linux/linux-riscv";
    stop;
}

if allof (address :contains ["to", "cc"] "soc@kernel.org") {
    fileinto "INBOX/Linux/linux-soc";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-spi@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-spi";
    stop;
}

if allof (address :contains ["to", "cc"] "stable@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-stable";
    stop;
}

if allof (address :contains ["to", "cc"] "linux-wireless@vger.kernel.org") {
    fileinto "INBOX/Linux/linux-wireless";
    stop;
}

if allof (address :contains ["to", "cc"] "consumption@bootlin.com") {
    fileinto "INBOX/Bootlin/consumption";
    stop;
}

if allof (address :contains ["to", "cc"] "accounting@bootlin.com") {
    fileinto "INBOX/Bootlin/accounting";
    stop;
}

if allof (address :contains ["to", "cc"] "info@bootlin.com") {
    fileinto "INBOX/Bootlin/info";
    stop;
}

if allof (address :contains ["to", "cc"] "internalstaff@bootlin.com") {
    fileinto "INBOX/Bootlin/internalstaff";
    stop;
}

if allof (address :contains ["to", "cc"] "ivenix@lists.bootlin.com") {
    fileinto "INBOX/Bootlin/ivenix";
    stop;
}

if allof (address :contains ["to", "cc"] "keysight@lists.bootlin.com") {
    fileinto "INBOX/Bootlin/keysight";
    stop;
}

if allof (address :contains ["to", "cc"] "permanentstaff@bootlin.com") {
    fileinto "INBOX/Bootlin/permanentstaff";
    stop;
}

if header :regex :comparator "i;ascii-casemap" "subject" "\\[projects/[a-zA-Z0-9_-]+\\]\\s+" {
    fileinto "INBOX/Bootlin/projects";
    stop;
}

if allof (address :contains ["to", "cc"] "trainingstaff@bootlin.com") {
    fileinto "INBOX/Bootlin/trainingstaff";
    stop;
}

if allof (address :contains ["to", "cc"] "technicalstaff@bootlin.com") {
    fileinto "INBOX/Bootlin/technicalstaff";
    stop;
}

if allof (address :contains ["to", "cc"] "libmbim-devel@lists.freedesktop.org") {
    fileinto "INBOX/Misc/libmbim-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "modemmanager-devel@lists.freedesktop.org") {
    fileinto "INBOX/Misc/modemmanager-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "kas-devel@googlegroups.com") {
    fileinto "INBOX/Misc/kas-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "libqmi-devel@lists.freedesktop.org") {
    fileinto "INBOX/Misc/libqmi-devel";
    stop;
}

if allof (address :contains ["to", "cc"] "op-tee@lists.trustedfirmware.org") {
    fileinto "INBOX/op-tee";
    stop;
}

if allof (address :contains ["to", "cc"] "opensbi@lists.infradead.org") {
    fileinto "INBOX/OpenSBI";
    stop;
}

if allof (address :contains ["to", "cc"] "qemu-riscv@nongnu.org") {
    fileinto "INBOX/Qemu";
    stop;
}

if allof (address :contains ["to", "cc"] "tf-a@lists.trustedfirmware.org") {
    fileinto "INBOX/TF-A";
    stop;
}

if allof (address :contains ["to", "cc"] "tf-m@lists.trustedfirmware.org") {
    fileinto "INBOX/TF-M";
    stop;
}

if allof (address :contains ["to", "cc"] "announce@lists.zephyrproject.org") {
    fileinto "INBOX/Zephyr";
    stop;
}

if allof (address :contains ["to", "cc"] "devel@lists.zephyrproject.org") {
    fileinto "INBOX/Zephyr/devel";
    stop;
}

if allof (address :contains ["to", "cc"] "main@lists.zephyrproject.org") {
    fileinto "INBOX/Zephyr/main";
    stop;
}

if allof (address :contains ["to", "cc"] "users@lists.zephyrproject.org") {
    fileinto "INBOX/Zephyr/users";
    stop;
}
